!function(){"use strict";angular.module("app.diagnostics",[]).service("telemetry",["$injector","constants","ariaTelemetry",function(e,t,i){var n=[i],r=async function(i){var n=e.get("userService");Utilities.isUndefinedOrNull(i)&&(i={}),i.pii=[];var r=Utilities.getManifest();r&&(i.appVersion=r.version),i["Session.Id"]=Utilities.getGuid(),i["App.Platform"]="Web",i["App.Name"]="EditorBX";var a=BrowserHandler.i18n.getUILanguage();Utilities.isNotUndefinedOrNull(a)&&(i.language=a),i["AppInfo.Name"]=t.APPINFO_NAME;var s=await n.getUserType(),l=AWTLogManager.getSemanticContext();if(s===t.USER_TYPE.NONE)return l.setUserId("","",""),i;if(s===t.USER_TYPE.O365){var d=await n.getTenant(s);Utilities.isNotUndefinedOrNull(d)&&(i.Tenant_Id=d)}i.Identity_Provider=s;var o=await n.getUserInfo(s);return Utilities.isUndefinedOrNull(o)?(l.setUserId("","",""),i):(Utilities.isNotUndefinedOrNull(o.id)&&(i["Data.User_Id"]=o.id,l.setUserId(o.id)),i)},a=function(){var t=e.get("$q"),i=e.get("storage"),n=t.defer();return i.get("enableTelemetry").then((function(e){n.resolve(Utilities.isUndefinedOrNull(e)||!0===function(e,t){if(e[t]){var i=JSON.parse(e[t]);if(void 0!==i.value)return JSON.parse(i.value)}}(e,"enableTelemetry"))})),n.promise};return{getEnabledSetting:function(){return a()},setEnabledSetting:function(i){if(Utilities.isBackgroundContext()){!function(t){e.get("storage").set({enableTelemetry:JSON.stringify({value:JSON.stringify(t),lastUpdate:Date.now(),manualOverride:!1})})}(i);for(var r=0;r<n.length;++r)n[r].setEnabledSetting(i)}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.CHANGE_TELEMETRY_VALUE,enabled:i})},trackEvent:async function(e,i,a){if(!angular.isUndefined(e)&&angular.isString(e))if(Utilities.isBackgroundContext()){i=await r(i);for(var s=0;s<n.length;++s){var l=angular.extend({},i);n[s].trackEvent(e,l,a)}}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.TRACK_EVENT,eventName:e,properties:i,measurements:a})},trackTrace:async function(e,i){if(!angular.isUndefined(e)&&angular.isString(e))if(Utilities.isBackgroundContext()){i=await r(i);for(var a=0;a<n.length;++a){var s=angular.extend({},i);n[a].trackTrace(e,s)}}else BrowserHandler.runtime.sendMessage({activity:t.ACTIVITY.TELEMETRY.NAME,command:t.TELEMETRY.COMMAND.TRACK_TRACE,message:e,properties:i})}}}])}();