!function(){"use strict";angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msidUserService","editorUtils",function(e,t,r,n,a,i,o,s){Utilities.isBackgroundContext()&&BrowserHandler.runtime.onMessage.addListener((function(e,r,a){switch(e.activity){case n.ACTIVITY.LOGOUT.NAME:return T().then(()=>{a()}),!0;case n.ACTIVITY.AUTHENTICATION.NAME:return m(e.type).then(e=>{a(e)}).catch(()=>{t.error("failed to login")}),!0;case n.ACTIVITY.AUTHORIZATION.NAME:return r.id===chrome.runtime.id&&e.close&&(r.tab&&r.tab.id&&BrowserHandler.tabs.remove(r.tab.id),delete e.close),l(w(e)).then(()=>{a()}),!0;case n.ACTIVITY.REQUEST_TOKEN.NAME:return y(e.data.url,e.data.type,e.data.inIFrame).then(e=>{a(e)}).catch(()=>{t.error("error navigating to auth endpoint")}),!0;default:return}}));async function c(e,r,a,i){var o={};if(!(o=await U(e)))return t.error("userService.acquireToken - Invalid type"),Promise.reject("Invalid userType");!a&&o.getResourceForEndpoint&&(a=o.getResourceForEndpoint(r));var s={};try{if((s=await b(r,a))&&s.access_token&&!x(s.expires_on))return s;if(!(s=await async function(e,r,a){if(!e)return t.error("userService.requestAccessToken - Invalid type"),Promise.reject("Invalid userType");const i=await async function(){return A("refresh_token")}();if(i)return async function(e,r,a){if(!e)return t.error("userService.refreshAccessToken - Invalid type"),Promise.reject("Invalid userType");var i=e.getConfig();i.params.grant_type=n.OAUTH.REFRESH_TOKEN,i.params.resource=r,i.params.refresh_token=a;var o={method:"POST",url:i.tokenUrl,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:new URLSearchParams(i.params).toString()};return await u(o)}(e,r,i);const o=await g();var s,c=await O(o);e.requestAccessToken&&(s=await e.requestAccessToken(r,c,a));return s}(o,a,i)))return Promise.reject("No tokens available");await P(o,r,s)}catch(n){t.error(`${Error().stack.split("\n")[2].trim()} failed. reason: ${n}, userType: ${e}, endpoint: ${r}, resource: ${a}`)}return s&&s.access_token&&s.expires_on&&!x(s.expires_on)?s:null}async function u(e){if(!e)return Promise.reject("Invalid Request");const t=r.get("$http");var n=(new Error).stack;return(await t(e).then(e=>e,t=>Promise.reject(`httpRequest failed for url: ${e.url} stack:\n ${n}`))).data}async function l(e){const r=e.type;var n=void 0,a=await U(r);if(a){if(e.id_token&&(n=await v(e.id_token)),e.access_token){await P(a,a.getConfig().userInfoUrl,e),n||(n=await g());await s.isFeatureFlagEnabled("enableRoamingService")&&!a.shouldGetUserInfo(e)||await V(a,e.id_token)}e.error&&t.error("userService.authenticate - authentication returned error")}else t.error("userService.authenticate - Invalid type")}async function d(){return Promise.all([a.remove("accessToken"),a.remove("refreshToken"),a.remove("userInfo"),a.remove("userType"),a.remove("identity"),a.remove("postUpsellAnnouncementVisible"),a.remove("postUpsellAnnouncementDismissed"),a.remove("postUpsellAnnouncementHadSubscription")])}async function f(){return Promise.all([a.remove("userExcludedUrls"),a.remove("showSynonyms"),a.remove("enableTelemetry"),a.remove("enableEditor"),a.remove("enableSpelling"),a.remove("enableGrammar"),a.remove("enableRefinements"),a.remove("proofingLanguage"),a.remove("proofingLanguages"),a.remove("defaultProofingLanguageInitialized"),a.remove("proofingLanguageListInitialized"),a.remove("critiqueValuePerLanguage")])}async function p(){var e=await a.get(["userType","identity"]);return e.identity&&e.userType&&e.userType!==n.USER_TYPE.NONE}async function E(){var e=await a.get(["userType","identity"]),t=e.userType;if(t&&t!==n.USER_TYPE.NONE&&e.identity){var r=e.identity[t];if(r&&r.userInfo){var i=r.userInfo;switch(t){case n.USER_TYPE.O365:return i.activeExperiences&&Array.isArray(i.activeExperiences)?i.activeExperiences.some(e=>"OfficeProPlus"===e)?n.LICENSE_TYPE.SUBSCRIPTION:n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.MSA:if(!i.activeSubscriptionProduct)return;return"none"===i.activeSubscriptionProduct?n.LICENSE_TYPE.NO_LICENSE:n.LICENSE_TYPE.SUBSCRIPTION;case n.USER_TYPE.NONE:default:return}}}}async function g(){return(await a.get("userType")).userType||n.USER_TYPE.NONE}async function v(e){var r="";if(Object.values(n.USER_TYPE).includes(e))r=e;else{var i=function(e){var t=e.scopes||e.scope;if(t&&t.includes("wl."))return{type:n.USER_TYPE.MSA};var r=e.id_token||e;if(!r)return{type:n.USER_TYPE.NONE};const a={"9188040d-6c67-4c5b-b112-36a304b66dad":{type:n.USER_TYPE.MSA,audience:"prod"},"4925308c-f164-4d2d-bc7e-0631132e9375":{type:n.USER_TYPE.MSA,audience:"ppe"},"72f988bf-86f1-41af-91ab-2d7cd011db47":{type:n.USER_TYPE.O365,audience:"prod",domain:"microsoft.com"},"f686d426-8d16-42db-81b7-ab578e110ccd":{type:n.USER_TYPE.O365,audience:"ppe",domain:"microsoft.com"}};try{const{header:e,payload:t}=j(r);var i={tenant:t.tid};if(a.hasOwnProperty(i.tenant)){var o=a[i.tenant];i=Object.assign(i,o)}else i.type=n.USER_TYPE.O365;return i}catch(e){return{type:n.USER_TYPE.MSA}}}(e);r=i.type,delete i.type;var o={[r]:i},s=await _();if(angular.equals(s,{})){const e=await S(!1);t.trackEvent("IdentityPopulated",{clientId:e})}h(s,o),await a.set({identity:s})}return r!==n.USER_TYPE.NONE&&await a.set({userType:r}),r}function w(e){e.state&&(e.state=decodeURIComponent(e.state));var[t,r,n]=e.state.split("|");return r&&(e.type=r),e}async function y(e,r,a){return new Promise(async(i,o)=>{if(Utilities.isBackgroundContext()){const E=(e=new URL(e)).searchParams;for(const e of["state","nonce"]){var s=E.get(e);s||(s=K()),"state"===e&&r&&(s+="|"+r+"|"+n.APPINFO_NAME),E.set(e,s)}var c=void 0,u=void 0;function l(){if(BrowserHandler.runtime.onMessage.removeListener(d),c){var e=document.getElementById(c);e&&e.parentNode.removeChild(e)}}function d(r,a,s){if(r.activity===n.ACTIVITY.AUTHORIZATION.NAME){t.debug("auth listener received: "+e);const n=w(r);n&&n.state===g||(t.error("auth response received with error: null response or state not matching"),o(n)),n.error?t.error("auth response received with error"):n.access_token?t.info("auth listener received successfully"):t.error("auth response received with unknown error"),u&&clearTimeout(u),delete r.activity,l(),i(n)}}const g=E.get("state"),v=E.get("scope");t.info("loading auth url "+(a?"in iframe":"")),BrowserHandler.runtime.onMessage.addListener(d);var f=await O();if(f&&f.email&&!E.has("login_hint")&&E.set("login_hint",f.email),a){E.set("prompt","none"),c="authFrame!"+v;const r=6e4;u=setTimeout(()=>{t.warn(`userService.authInFrame timed out after ${r} ms`),l(),o("Timed out waiting for response from iFrame")},r);var p=document.getElementById(c);p||((p=document.createElement("iframe")).setAttribute("id",c),p.style.visibility="hidden",p.style.position="absolute",p.style.width=p.style.height="0",p.style.border="0",p.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),document.body.appendChild(p),p.src=e.toString())}else BrowserHandler.tabs.create({url:e.toString()})}else BrowserHandler.runtime.sendMessage({activity:"requestToken",data:{url:e,type:r,inIFrame:a}},e=>{i(e)})})}async function S(e){const t=await a.get("clientId"),r=s.readSettingValueOrUndefined(t,"clientId");if(!r&&e){const e=K();return s.writeEditorSettingValue("clientId",e),e}return r}async function m(e){await d();var r=await U(e);if(r.handleLogin)return r.handleLogin(service);var n=r.getConfig().loginUrl;if(n)return await y(n,r.type);t.error("userService.login - Invalid type")}async function T(){const e=await g();var r=await U(e);if(d(),f(),r.handleLogout)await r.handleLogout(service);else{var n=r.getConfig().logoutUrl;if(!n)return void t.error("userService.logout - Invalid type");var a={method:"GET",url:n};await u(a)}t.debug("userService.logout - "+e)}async function I(e){var t=await A("service",e);return t||n.USER_SERVICE_TYPE.MSID}async function U(e){var r=null;return Object.values(n.USER_SERVICE_TYPE).includes(e)||(e=await I(e)),-1!==e.indexOf(n.USER_SERVICE_TYPE.MSID)?r=o:t.error("userService.userService - Invalid type - "+e),r}async function _(){var e=await a.get("identity");return e&&e.identity?e.identity:{}}function h(e,r){for(var[n,a]of Object.entries(r))(a||0===a)&&(e[n]&&"none"!==e[n]&&"none"!==a?typeof a==typeof e[n]?Array.isArray(a)?a.forEach((t,r)=>{e[n].indexOf(t)<0&&e[n].push(t)}):"object"!=typeof a?e[n]=a:h(e[n],a):t.warn(`skipping ${n} due to conflicting types`):e[n]=a)}function N(e){return new URL(e).origin}async function P(e,r,i){if(i.expires_in&&!i.expires_on&&(i.expires_on=Utilities.getCurrentTime()+Number(i.expires_in)),!r)return void t.error("userService.saveTokens - endpoint not provided");var o=await g();if(o===n.USER_TYPE.NONE&&(o=await v(i)),o===n.USER_TYPE.NONE)return void t.error("userService.saveTokens - unable to resolve userType");var s=decodeURIComponent(i.scope).toLowerCase().split(/[ +]/);const c=e.getScopeEndpointMap();for await(const e of s){var u=e.match(/(^https:\/\/[\.\w]*(?:\S+\/))/i);if(u){r=u[u.index];break}if(c[e]){r=c[e];break}}r=N(r),i.resource&&i.resource!==r&&(t.info(`saveTokens ${r} does not match ${i.resource}`),r=i.resource);var l={[o]:{id_token:i.id_token,refresh_token:i.refresh_token,service:e.type,resources:{[r]:{access_token:i.access_token,expires_in:i.expires_in,expires_on:i.expires_on,scope:s}}}},d=await _();h(d,l),await a.set({identity:d})}function R(e,t){if(!e)return!0;Array.isArray(e)||(e=e.toLowerCase().split(/[ +]/));for(const r of e)if(!t.includes(r))return!1;return!0}async function b(e,r){if(e){e=N(e);try{var n=await A("resources");if(n[e]){var a=n[e];if(e===r)return a;if(a&&R(r,a.scope))return a;delete n[e]}for(const e in n)if(R(r,e.scope))return e;return null}catch(e){return null}}else t.error("userService.getAccessToken - endpoint not provided")}async function O(e){return A("userInfo",e)}async function A(e,t){t||(t=await g());var r=await _();return r[t]&&r[t][e]?r[t][e]:null}async function L(e,t,r){var n=await _(),i={};n[e]&&n[e].userInfo&&!r&&(i=n[e].userInfo),h(i,t),n[e]&&(n[e].userInfo=i,await a.set({identity:n}))}function x(e){var t=Utilities.getCurrentTime();return!(e&&e>t+120)}async function F(e){var r={},a={method:"GET",url:n.MSACONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var i=await u(a);if(i){var o=await g();r={activeSubscriptionProduct:i.ActiveSubscriptionProduct?i.ActiveSubscriptionProduct:"none"},await L(o,r)}}catch(e){t.error("Call to Shell consumer license service failed.")}return r}async function C(e){var r={},a={method:"GET",url:n.O365CONFIG.LICENSE_ENDPOINT,headers:{"X-UserType":e.type}};try{var i=await u(a);if(i&&i.ActiveExperiences){var o=await g();r={activeExperiences:i.ActiveExperiences},await L(o,r)}}catch(e){t.error("Call to Shell commercial license service failed.")}}let k,M=0;async function Y(){const e=await g();clearTimeout(k),k=void 0;const r=M>3;if(!await s.isFeatureFlagEnabled("enableRoamingService")||e===n.USER_TYPE.NONE||r)return!1;let a;try{a=e===n.USER_TYPE.MSA?await async function(e){const{endpoint:t,resource:r}=B(e);let n=await c(e,t,r,!0);if(!n)throw"Roaming token not found!";return n}(e):await async function(e){const{endpoint:t,resource:r}=B(e);let n=await c(e,t,r,!1);if(!n)throw"Roaming token not found!";return n}(e)}catch(e){return t.error(`failed to fetch Roaming Info, trial number: ${M}, reason: ${e}`),M++,Y()}return t.info("got roaming token successfully, trial number: "+M),M=0,a?function(e){const t=1e3*e.expires_on-Date.now(),r=Math.min(216e5,t);t>0?k=setTimeout(()=>{G()},r):Y()}(a):t.error("Roaming token is undefined"),!!a}async function G(){const e=await g(),r=await I(e),a=await U(r);if(await s.isFeatureFlagEnabled("enableRoamingService")&&e!==n.USER_TYPE.NONE)try{const{endpoint:t,resource:r}=B(e),n=await async function(e,t,r){const n=await b(t,r);if(!n)return{};return await P(e,t,{...n,expires_on:1}),n}(a,t,r),i=n&&n.access_token&&!x(n.expires_on);!await Y()&&i&&await P(a,t,n)}catch(e){t.error("failed to init Roaming token fetching, reason: "+e)}}function B(e){if(e===n.USER_TYPE.NONE)throw new Error("Unexpected user type, user is not signed in!");return e===n.USER_TYPE.MSA?{endpoint:n.MSACONFIG.ROAMING_URL,resource:n.MSACONFIG.ROAMING_SCOPE}:{endpoint:n.O365CONFIG.ROAMING_URL,resource:n.O365CONFIG.ROAMING_URL}}async function H(e,r,a){return t.trackEvent("FetchLicenseInfo",{isRefresh:a,userType:e}),await(e===n.USER_TYPE.MSA?F:C)(r)}async function V(e,r){var a=await g();try{var i=await e.lookupUserInfo(r);await s.isFeatureFlagEnabled("enableAadc")&&(i.ageGroup=await $(a,r)),BrowserHandler.runtime.sendMessage({activity:n.ACTIVITY.USERINFO_AVAILABLE.NAME,data:i}),!i.email&&i.userPrincipalName&&(i.email=i.userPrincipalName),await L(a,i,!0),await q(e),await H(a,e,!1),await Y()}catch(e){t.error("failed while looking up user info")}}async function $(e,r){let n=0;const a=await O(e);if(a&&a.ageGroup)return a.ageGroup;if(!r)return n;try{const{payload:e}=j(r);n=e&&e.ageGroup||0}catch(e){t.error("error setting age group, reason: "+e)}return n}function j(e){var r=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);return!r||r.length<4?(t.error("The returned id_token is not parseable."),null):{header:JSON.parse(D(r[1])),payload:JSON.parse(D(r[2]))}}function D(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(e)))}async function q(e){const r=e.type,a=await g();var i=e.getConfig()[a===n.USER_TYPE.MSA?"msaPhotoUrl":"aadPhotoUrl"];if(i){var o={method:"GET",url:i,responseType:"blob",headers:{"X-UserType":r}};try{const e=await u(o);t.trackEvent("UserService_GotServerPhoto",{userType:a});var s=new FileReader;s.onload=async()=>(L(a,{photo:s.result}),s.result),s.readAsDataURL(e)}catch(e){return null}}}function K(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=performance.now();const r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?r:3&r|8).toString(16)}))}return G(),{acquireToken:c,addAgeGroupToUserInfo:async function(){if(!await s.isFeatureFlagEnabled("enableAadc"))return;var e=await g();if(e===n.USER_TYPE.NONE)return;const t=await async function(e){return A("id_token",e)}(e),r=await $(e,t);await L(e,{ageGroup:r},!1)},onInstall:async function(){try{const{enableSignInExperiment:o,enableAutomaticSignIn:s}=await async function(...e){const t=await S(!0),r=function(){const e=browser.runtime.getManifest();return{storeId:browser.runtime.id,languageUxId:browser.i18n.getUILanguage(),extensionId:e.version}}(),a={appId:n.APP_ID,...r},i={method:"POST",url:n.LINKS.FLIGHT_INFO_URL,headers:{"Content-Type":"application/json","X-UserId":t},data:a},o=await u(i),s={};for(const t of e)s[t]=!!o&&!!o.FeatureFlags&&!!o.FeatureFlags[t]&&"true"===o.FeatureFlags[t].toLowerCase();return s}("enableSignInExperiment","enableAutomaticSignIn");if(o){const e=await S(!1);t.trackEvent("AutoSignInExperiment",{isAutoSignInEnabled:s,clientId:e})}const c=s&&!await p();r=function(e){return Utilities.isChrome()?e?n.LINKS.POST_INSTALL_CHROME_AUTO_URL:n.LINKS.POST_INSTALL_CHROME_URL:Utilities.isEdge()?e?n.LINKS.POST_INSTALL_EDGE_AUTO_URL:n.LINKS.POST_INSTALL_EDGE_URL:n.POST_INSTALL_URL}(c),a=null,(i=e.defer()).resolve(Utilities.isNotUndefinedOrNull(a)?a:function(t){Utilities.isUndefinedOrNull(t)&&(t=n.LINKS.PROGRESSPAGE_URL);var r=e.defer();return BrowserHandler.windows.getAll((function(e){0===e.length?BrowserHandler.windows.create({url:t,type:"normal"},(function(e){r.resolve(e.tabs[0].id)})):BrowserHandler.tabs.create({url:t},(function(e){r.resolve(e.id)}))})),r.promise}(r)),i.promise.then((function(e){Utilities.isUndefinedOrNull(e)?t.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):BrowserHandler.tabs.update(e,{url:r})})),c&&m(n.USER_SERVICE_TYPE.MSID)}catch(e){t.error("failed to auto sign in")}var r,a,i},clearToken:d,isBetaActiveForCurrentPage:async function(){const e=await s.isFeatureFlagEnabled("enableBetaExperience"),t=await p();if(!e||!t)return!1;const r=await s.getCurrentTabHostName(),n=await a.get("BetaEnrollment"),i=s.readSettingValueOrUndefined(n,"BetaEnrollment");return JSON.parse(i).some(e=>function(e,t){const r=new RegExp(t);return null!==r.exec(e)}(r.url,e.url)&&2===e.state)},isConditionalSignInMessageEnabled:async function(){return await s.isFeatureFlagEnabled("enableConditionalSignInMessage")},isLoggedIn:p,isUpsellFeatureEnabled:async function(){const e=await s.isFeatureFlagEnabled("enableAadc"),t=await s.isFeatureFlagEnabled("enableUpsellFeature");if(!e)return t;const r=await g();return await async function(e){const t=await O(e);if(!t)return!0;return void 0===t.ageGroup||0===t.ageGroup||3===t.ageGroup||5===t.ageGroup}(r)&&t},isUserDictionaryAnnouncementEnabled:async function(){return await s.isFeatureFlagEnabled("enableUserDictionaryAnnouncement")},isMultiLangFeatureEnabled:async function(){return await s.isFeatureFlagEnabled("enableMultiLanguageSupport")},isUpsellUser:async function(){var e=await a.get(["userType","identity"]),t=e.identity&&e.userType&&e.userType===n.USER_TYPE.MSA,r=e.identity?e.identity[n.USER_TYPE.MSA]:void 0;if(!(t&&r&&r.userInfo&&r.userInfo.activeSubscriptionProduct))return!1;if("none"===r.userInfo.activeSubscriptionProduct)return!0;return!1},isPremiumUser:async function(){return await E()===n.LICENSE_TYPE.SUBSCRIPTION},isUnsignedInEditorEnabled:async function(){var e=await s.isFeatureFlagEnabled("enableUnsignedInEditor"),t=await s.isFeatureFlagEnabled("enableSuppressUnsignedInEditorForMultiLang");const r=(await new Promise(e=>{BrowserHandler.i18n.getAcceptLanguages(t=>e(t))})).reduce((e,t)=>{const r=t.split("-");if(r.length>0){const t=r[0];e.add(t)}return e},new Set);return e&&(!t||r.size<=1)},enableRoamingTokenFetch:function(){if(k)return;Y()},getEndpointUrlForCurrentUser:async function(e){const t=await g();if(!t||t===n.USER_TYPE.NONE)return null;var r=await U(t);if(!r)return null;return r.getConfig()[e]},getUserType:g,getUserInfo:O,getUserPhoto:async function(){var e=await g();if(e===n.USER_TYPE.NONE)return t.warn("UserService.getUserPhoto: no signed-in user"),Promise.reject(n.RECENTS.ERROR.UNSUPPORTED_USER_TYPE);var r=await O(e);if(r&&r.photo)return t.trackEvent("UserService_GotLocalPhoto",{userType:e}),r.photo;return Promise.reject("No photo in local storage")},httpRequest:u,navigateToAuthEndpoint:y,saveUserInfo:L,waitForUserInfo:async function(e){return new Promise(async r=>{var a=await O(e);if(Utilities.isNotUndefinedOrNull(a))return r(a);BrowserHandler.runtime.onMessage.addListener(s);var i=Utilities.isExtensionInTestingMode()?n.TIMEOUT.USER_INFO_LOOKUP_TEST:n.TIMEOUT.USER_INFO_LOOKUP,o=setTimeout(()=>{t.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",n.TIMEOUT.USER_INFO_LOOKUP,e)),c(),r(a)},i);function s(e){e.activity===n.ACTIVITY.USERINFO_AVAILABLE.NAME&&(c(),clearTimeout(o),r(e.data))}function c(){BrowserHandler.runtime.onMessage.removeListener(s)}})},getLicenseType:E,authorize:l,getAccessToken:b,getPhotoFromServer:q,login:m,logout:T,lookupUserInfo:V,getTenant:async function(e){return A("tenant",e)},refreshLicense:async function(){t.debug("Refreshing license");var e=await g();if(e===n.USER_TYPE.NONE)return{refreshed:!1};var r=await I(e),a=await U(r);if(null===a)return{refreshed:!1};return{refreshed:!0,data:await H(e,a,!0)}},clearUserSettings:f}}])}();