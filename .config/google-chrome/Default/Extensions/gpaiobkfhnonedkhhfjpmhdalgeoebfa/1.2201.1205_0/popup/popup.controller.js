!function(){"use strict";angular.module("app.popup",[]).controller("PopupController",["$timeout","$scope","$log","$document","constants","storage","userService","localize",function(e,n,t,i,o,s,r,c){var a=this,l=null,u=null,d=null;function S(){t.trackEvent("PopupSignOutLinkClick"),BrowserHandler.runtime.sendMessage({activity:o.ACTIVITY.LOGOUT.NAME,type:n.userType}),a.hasSignedIn=a.constants.SIGNINSTATUS.NONE,n.userType=a.constants.USER_TYPE.NONE,s.remove("localRecentDocuments"),e((function(){a.focusFirstElement()}),0)}a.accountPanelOpened=!1,a.filesSelected=null,a.focusVisible=!1,a.webRedirectInputChecked=!1,a.telemetryInputChecked=!1,a.onLine=!0,a.username="",a.email="",a.profilePicture="",a.rtl=Utilities.isRTL(),a.isChrome=Utilities.isChrome(),a.refinementsTooltipVisible=!1,a.signoutTooltipVisible=!1,a.editorFeatureEnabled=Utilities.isEditorEnabled(),a.onMenuItemClick=function(e){a.currentViewMode=a.currentViewMode===e?a.constants.MENU_VIEWMODE.NONE:a.currentViewMode=e},a.onSignOutClick=function(){a.currentViewMode=a.constants.MENU_VIEWMODE.NONE,a.hasSignedIn===a.constants.SIGNINSTATUS.SIGNEDIN&&S(),window.location.reload()},a.onWelcomeSignInClick=async function(e,n){return t.trackEvent("PopupSignInLinkClick",{eventFrom:n}),window.close(),new Promise(async n=>{BrowserHandler.runtime.sendMessage({activity:a.constants.ACTIVITY.AUTHENTICATION.NAME,type:e},e=>{n()})})},a.onProfileClick=function(){a.accountPanelOpened=!a.accountPanelOpened},a.onPopupKeydown=function(e){"Tab"!==e.key&&" "!==e.key||a.focusVisible||(a.focusVisible=!0)},a.onSignOutLinkClick=S,a.onSignupLinkClick=function(){t.trackEvent("PopupSignupLinkClick"),Utilities.navigateToUrlWithNewTab(a.constants.LINKS.SIGNUP,!0)},a.onWebRedirectInputChange=function(){a.webRedirectInputChecked=!a.webRedirectInputChecked,a.storage.set({webRedirect_disabled:!a.webRedirectInputChecked}),t.trackEvent("PopupWebRedirectChecked",{enabled:a.webRedirectInputChecked})},a.onTelemetryInputChange=function(){a.telemetryInputChecked=!a.telemetryInputChecked,t.setEnabledSetting(a.telemetryInputChecked),t.trackEvent("PopupTelemetryInputChecked",{enabled:a.telemetryInputChecked})},a.onFeedbackClick=function(){Utilities.navigateToUrlWithNewTab(BrowserHandler.extension.getURL(a.constants.LINKS.FEEDBACK_URL),!0)},a.openSupportPage=function(){Utilities.navigateToUrlWithNewTab(o.LINKS.LOGIN_SUPPORT_URL,!0)},a.openMyAccountPage=function(){var e=n.userType===a.constants.USER_TYPE.O365?a.constants.LINKS.MYACCOUNT_O365_URL:a.constants.LINKS.MYACCOUNT_MSA_URL;Utilities.navigateToUrlWithNewTab(e,!0)},a.constants=o,a.storage=s,a.userService=r,a.localize=c,a.hasSignedIn=a.constants.SIGNINSTATUS.UNKNOWN,a.isUnsignedInEditorEnabled=!1,a.showRefinementsTooltip=function(){u=e((function(){a.refinementsTooltipVisible=!0}),500)},a.hideRefinementsTooltip=function(){e.cancel(u),a.refinementsTooltipVisible=!1},a.showGrammarTooltip=function(){l=e((function(){a.grammarTooltipVisible=!0}),500)},a.hideGrammarTooltip=function(){e.cancel(l),a.grammarTooltipVisible=!1},a.showSignoutTooltip=function(){d=e((function(){a.signoutTooltipVisible=!0}),500)},a.hideSignoutTooltip=function(){e.cancel(d),a.signoutTooltipVisible=!1},a.focusFirstElement=async function(){var e=".login_button";(a.hasSignedIn!==a.constants.SIGNINSTATUS.NONE||await a.userService.isUnsignedInEditorEnabled())&&(e="#editor-spelling-toggle");var n=document.querySelector(e);n&&(a.focusVisible=!0,n.focus())},a.onMouseMove=function(){a.focusVisible=!1},a.onMouseEnter=function(){a.focusVisible=!1,n.$apply()},a.currentViewMode=a.constants.MENU_VIEWMODE.NONE,n.userType=a.constants.USER_TYPE.NONE,a.menuItems=[{id:"AccountInfo",label:"AccountLabel",iconClass:"o365-Icon--person2",viewMode:a.constants.MENU_VIEWMODE.ACCOUNT},{id:"Settings",label:"SettingsLabel",iconClass:"o365-Icon--gear",viewMode:a.constants.MENU_VIEWMODE.SETTINGS}],i.ready((function(){e((function(){t.trackEvent("PopupPageLoad")}));for(var n=document.querySelectorAll(".ms-Spinner"),i=0;i<n.length;i++)new fabric.Spinner(n[i]);var o=document.querySelectorAll(".ms-CheckBox");for(i=0;i<o.length;i++)new fabric.CheckBox(o[i]);e((async function(){await a.focusFirstElement()}))})),document.addEventListener("mousemove",a.onMouseMove),document.addEventListener("mouseenter",a.onMouseEnter),a.userService.isUnsignedInEditorEnabled().then(e=>{a.isUnsignedInEditorEnabled=e,n.$apply()}),s.get(["userType","identity"]).then(e=>{var i=e&&e.identity&&e.userType!==o.USER_TYPE.NONE;a.hasSignedIn=i?a.constants.SIGNINSTATUS.SIGNEDIN:a.constants.SIGNINSTATUS.NONE,a.hasSignedIn>a.constants.SIGNINSTATUS.NONE&&(t.debug("PopupController.refreshSignInStatus(): Method start"),a.userService.getUserType().then((async function(e){if(t.debug(String.format("PopupController.getSignInStatus(): hasSignedIn: {0}",e)),t.trackEvent("PopupSignedIn",{userType:e}),n.userType=e,a.hasSignedIn=e===a.constants.USER_TYPE.NONE?a.constants.SIGNINSTATUS.NONE:a.constants.SIGNINSTATUS.SIGNEDIN,a.hasSignedIn===a.constants.SIGNINSTATUS.SIGNEDIN){var i=await a.userService.waitForUserInfo(e);Utilities.isUndefinedOrNull(i)?t.warn("self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):Utilities.isUndefinedOrNull(i.email)?t.warn("self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):(a.username=i.displayName,a.email=i.email,r.getUserPhoto().then((function(e){a.profilePicture=e,n.$apply()}),(function(e){a.profilePicture="",t.info(String.format("PopupController.getUserPhoto: Profile Picture Error - {0}",e))})))}})))}),t.getEnabledSetting().then((function(e){t.setEnabledSetting(e)}))}])}();