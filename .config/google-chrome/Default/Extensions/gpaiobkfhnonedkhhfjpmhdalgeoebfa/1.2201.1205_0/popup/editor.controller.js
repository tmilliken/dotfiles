!function(){"use strict";angular.module("app.editor",[]).controller("EditorController",["$scope","$log","constants","storage","userService","localize","editorUtils","languageUtils",function(e,t,n,i,r,o,a,d){var l=this,s=Object.freeze({undefined:0,enabled:1,disabled:2});function g(){if(l.isLoggedIn){var e=l.upsellFeatureEnabled&&l.editorIsUpsellUser?"EditorRefinementsGoPremiumTooltip":"EditorRefinementsTooltip";l.refinementsTooltipText=o.getLocalizedString(e)}else l.refinementsTooltipText=o.getLocalizedString("ebx_RefinementTooltip")}function u(e){"Enter"===e.key&&(l.editorSpellingToggle=!l.editorSpellingToggle,l.onEditorSpellingChange())}function c(e){"Enter"===e.key&&(l.editorGrammarToggle=!l.editorGrammarToggle,l.onEditorGrammarChange())}function b(e){"Enter"===e.key&&(l.editorRefinementsToggle=!l.editorRefinementsToggle,l.onEditorRefinementsChange())}function E(e){l.currentTabUrl=e.url,l.currentHostName=e.hostname,l.editorDisableShow=!1,l.editorEnableShow=!1,l.editorSiteBlockedShow=!1,l.currentHostName?(l.editorSiteBlockedShow=a.siteIsBlocked(l.currentTabUrl),l.editorIsBlockedLabel=a.getFormattedLocalizedString("EditorIsBlockedOnThisSiteLabel",l.currentHostName),l.editorSiteBlockedShow?l.storage.get(["websitesWithNativeIntegration"]).then((function(e){var t=a.readSettingValueOrUndefined(e,"websitesWithNativeIntegration");a.siteHasNativeIntegration(l.currentTabUrl,t)&&(l.editorIsBlockedLabel=a.getFormattedLocalizedString("EditorNativeSupportOnThisSiteLabel",l.currentHostName))})):l.storage.get(["userExcludedUrls","disabledWebSites"]).then((function(e){var t=l.currentHostName;l.userExcludedUrls=a.readSettingValueOrUndefined(e,"userExcludedUrls"),l.disabledWebSites=a.readSettingValueOrUndefined(e,"disabledWebSites"),l.editorDisableLabel=a.getFormattedLocalizedString("DisableEditorOnThisSiteLabel",t),l.editorEnableLabel=a.getFormattedLocalizedString("EnableEditorOnThisSiteLabel",t),l.editorIsDisabledLabel=a.getFormattedLocalizedString("EditorIsDisabledOnThisSiteLabel",t);var n=a.isHostNameExcluded(t,l.userExcludedUrls);a.isUrlExcluded(l.currentTabUrl,l.disabledWebSites)?(l.editorSiteBlockedShow=!0,l.editorDisableShow=!1,l.editorEnableShow=!1):(l.editorSiteBlockedShow=!1,l.editorDisableShow=!n,l.editorEnableShow=n),l.animationsEnabled=!0}))):l.animationsEnabled=!0}function m(){l.isGrammarSupported||!l.isConditionalSignInMessageEnabled?l.isUserDictionaryAnnouncementEnabled?l.signIntoEditorBody=o.getLocalizedString("ebx_signIntoEditorBodyWithUserDictionary"):l.signIntoEditorBody=o.getLocalizedString("ebx_signIntoEditorBody"):l.signIntoEditorBody=o.getLocalizedString("ebx_signIntoEditorBodyForSpellingOnlyUsers")}function f(){l.editorGrammarToggle=l.editorGrammarEnabled&&l.isLoggedIn}function S(){l.editorRefinementsToggle=l.editorRefinementsEnabled&&l.editorIsPremiumUser&&l.isLoggedIn}function h(){t.trackEvent("EditorUserInteraction",{name:"SpellingChange"}),a.writeEditorSettingValue("enableSpelling",l.editorSpellingToggle)}function L(){t.trackEvent("EditorUserInteraction",{name:"GrammarChange"}),a.writeEditorSettingValue("enableGrammar",l.editorGrammarToggle)}function U(){t.trackEvent("EditorUserInteraction",{name:"RefinementsChange"}),a.writeEditorSettingValue("enableRefinements",l.editorRefinementsToggle)}function v(){t.trackEvent("EditorUserInteraction",{name:"TurnOnClick"}),a.writeEditorSettingValue("enableEditor",!0),l.editorEnabled=!0}function p(){t.trackEvent("EditorUserInteraction",{name:"SettingsClick"}),a.openOptionsPage()}function I(e){var t=document.getElementById(e),n=0;if(t){var i=()=>{t.offsetParent?t.focus():n<10&&(n+=1,window.setTimeout(i,100))};window.setTimeout(i,0)}}function T(){t.trackEvent("EditorUserInteraction",{name:"DisableClick"});var e=a.getHostnameOnlyUrl(l.currentTabUrl);e&&(l.userExcludedUrls.push(e),a.writeEditorSettingValue("userExcludedUrls",l.userExcludedUrls),l.editorDisableShow=!1,l.editorEnableShow=!0,I("editor-enable-button"))}function k(){t.trackEvent("EditorUserInteraction",{name:"EnableClick"}),l.userExcludedUrls=l.userExcludedUrls.filter((function(e){return a.getUrlInfo(e).hostname!==l.currentHostName})),a.writeEditorSettingValue("userExcludedUrls",l.userExcludedUrls),l.editorDisableShow=!0,l.editorEnableShow=!1,I("editor-disable-button")}function w(){t.trackEvent("EditorUserInteraction",{name:"GoPremiumClick"}),Utilities.navigateToUrlWithNewTab(l.constants.LINKS.EDITOR_GO_PREMIUM_URL,!0)}function C(){BrowserHandler.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{eventId:"showFeedbackDialog",data:[]})}))}l.onLoad=function(){t.debug("Loading EditorController"),l.storage.get(["editorClientState","enableEditor","enableSpelling","enableGrammar","enableRefinements","proofingLanguages","critiqueValuePerLanguage"]).then((function(e){var t=a.readSettingValueOrUndefined(e,"editorClientState");void 0!==t&&(l.editorAvailable=t===s.enabled);var n=a.readSettingValueOrUndefined(e,"enableEditor");void 0!==n&&(l.editorEnabled=n);var i=a.readSettingValueOrUndefined(e,"enableSpelling");void 0!==i&&(l.editorSpellingToggle=i);var r=a.readSettingValueOrUndefined(e,"enableGrammar");void 0!==r&&(l.editorGrammarEnabled=r,f());var o=a.readSettingValueOrUndefined(e,"enableRefinements");void 0!==o&&(l.editorRefinementsEnabled=o,S());var d=a.readSettingValueOrUndefined(e,"proofingLanguages");void 0!==d&&(l.languageIds=d);var g=a.readSettingValueOrUndefined(e,"critiqueValuePerLanguage");if(void 0!==g){var u=JSON.parse(g);l.isGrammarSupported=!1;for(var c=0;c<u.length;c+=1)if(u[c].hasGrammar){l.isGrammarSupported=!0;break}m()}})),a.getCurrentTabHostName().then(E),l.userService.isLoggedIn().then((function(e){l.isLoggedIn=e,f(),S(),g()})),l.userService.isUpsellFeatureEnabled().then((function(e){l.upsellFeatureEnabled=e,g()})),l.userService.isMultiLangFeatureEnabled().then((function(e){l.isMultiLangFeatureEnabled=e,function(e){l.proofingLanguages=[];var t=[];e.forEach((function(e){var n=function(e){if(!e)return e;return e.split("-")[0].trim()}(e),i=d.getLanguageName(e),r=void 0!==i?i:e,o=void 0!==i?function(e){if(!e)return;var t=e.split("(")[0];return(t.charAt(0).toLocaleUpperCase()+t.substr(1)).trim()}(i):e;void 0===t[n]&&(t[n]={shortName:o,entries:[]}),t[n].entries.push(r)})),Object.keys(t).forEach((function(e){for(var n=t[e],i=n.shortName,r=n.entries,o=r.shift();l.isMultiLangFeatureEnabled&&r.length>0;){var d=r.length>1?"EditorMultipleProofingLanguagesLabel":"EditorTwoProofingLanguagesLabel";o=a.getFormattedLocalizedString(d,[o,r.shift()])}var s=a.getFormattedLocalizedString("EditorProofingLanguageAriaLabel",o);l.proofingLanguages.push({name:l.isMultiLangFeatureEnabled?i:o,locales:o,ariaLabel:s,langTag:e})})),l.proofingLanguageLabelName=l.proofingLanguages&&l.proofingLanguages.length>1?"EditorProofingLanguagesLabel":"EditorProofingLanguageLabel"}(l.languageIds)})),l.userService.isUpsellUser().then((function(e){l.editorIsUpsellUser=e,g()})),l.userService.isPremiumUser().then((function(e){l.editorIsPremiumUser=e,S()})),l.userService.isConditionalSignInMessageEnabled().then((function(e){l.isConditionalSignInMessageEnabled=e,m()})),l.userService.isUserDictionaryAnnouncementEnabled().then((function(e){l.isUserDictionaryAnnouncementEnabled=e,m()})),l.userService.isBetaActiveForCurrentPage().then((function(e){l.isBeta=e}))},l.constants=n,l.storage=i,l.userService=r,l.localize=o,l.animationsEnabled=!1,l.editorIsBlockedLabel="",l.editorAvailable=!1,l.editorDisableShow=!1,l.editorEnableShow=!1,l.editorIsUpsellUser=!1,l.upsellFeatureEnabled=!1,l.isMultiLangFeatureEnabled=!1,l.editorSiteBlockedShow=!1,l.editorIsPremiumUser=!1,l.isLoggedIn=!1,l.isConditionalSignInMessageEnabled=!1,l.isUserDictionaryAnnouncementEnabled=!1,l.isGrammarSupported=!1,l.isBeta=!1,l.editorRefinementsEnabled=!1,l.editorGrammarEnabled=!1,l.editorEnabled=!0,l.editorSpellingToggle=!0,l.editorGrammarToggle=!0,l.editorRefinementsToggle=!0,l.proofingLanguages=[],l.languageIds=[],g(),l.signIntoEditorBody=o.getLocalizedString("ebx_signIntoEditorBody"),l.onEditorTurnOnClick=v,l.onEditorSettingsClick=p,l.onEditorDisableClick=T,l.onEditorEnableClick=k,l.onEditorGoPremiumClick=w,l.onEditorSpellingChange=h,l.onEditorGrammarChange=L,l.onEditorRefinementsChange=U,l.onEditorSpellingKeyPress=u,l.onEditorGrammarKeyPress=c,l.onEditorRefinementsKeyPress=b,l.giveFeedback=C}])}();